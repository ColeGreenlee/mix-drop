# Caddyfile - MixDrop Production Reverse Proxy
# Automatic HTTPS with Let's Encrypt

# Global options
{
	# Email for Let's Encrypt notifications
	email {$ACME_EMAIL}

	# Use Let's Encrypt production (default)
	# For testing with staging certificates, uncomment:
	# acme_ca https://acme-staging-v02.api.letsencrypt.org/directory
}

# Main Application
{$APP_DOMAIN} {
	reverse_proxy app:3000 {
		# Health check
		health_uri /
		health_interval 30s
		health_timeout 10s

		# Forward real client IP
		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-For {remote_host}
		header_up X-Forwarded-Proto {scheme}
	}

	# Security headers
	header {
		# Prevent clickjacking
		X-Frame-Options "SAMEORIGIN"

		# HSTS - Force HTTPS for 1 year
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

		# Prevent MIME sniffing
		X-Content-Type-Options "nosniff"

		# XSS protection (legacy browsers)
		X-XSS-Protection "1; mode=block"

		# Referrer policy
		Referrer-Policy "strict-origin-when-cross-origin"

		# Remove server identification
		-Server
	}

	# Enable compression
	encode gzip zstd

	# Access logs
	log {
		output file /var/log/caddy/access.log {
			roll_size 100mb
			roll_keep 10
		}
	}
}

# MinIO S3 API
{$MINIO_DOMAIN} {
	reverse_proxy minio:9000 {
		# Forward real client IP
		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-For {remote_host}
		header_up X-Forwarded-Proto {scheme}
		header_up Host {host}
	}

	# Security headers
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
		-Server
	}

	# Enable compression
	encode gzip

	# Access logs
	log {
		output file /var/log/caddy/minio-access.log {
			roll_size 100mb
			roll_keep 10
		}
	}
}

# MinIO Console (Admin Access)
# Optional: Uncomment IP whitelist below to restrict access
{$MINIO_CONSOLE_DOMAIN} {
	# IP whitelist (uncomment to enable)
	# @allowed {
	#     remote_ip 1.2.3.4 5.6.7.8/24
	# }
	# handle @allowed {
		reverse_proxy minio:9001 {
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
			header_up X-Forwarded-Proto {scheme}
		}
	# }
	# handle {
	#     respond "Access Denied" 403
	# }

	# Security headers
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
		X-Frame-Options "DENY"
		-Server
	}

	# Access logs
	log {
		output file /var/log/caddy/minio-console-access.log {
			roll_size 100mb
			roll_keep 10
		}
	}
}

# Grafana (Admin Access)
# Optional: Uncomment IP whitelist below to restrict access
{$GRAFANA_DOMAIN} {
	# IP whitelist (uncomment to enable)
	# @allowed {
	#     remote_ip 1.2.3.4 5.6.7.8/24
	# }
	# handle @allowed {
		reverse_proxy grafana:3000 {
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
			header_up X-Forwarded-Proto {scheme}
		}
	# }
	# handle {
	#     respond "Access Denied" 403
	# }

	# Security headers
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
		X-Frame-Options "SAMEORIGIN"
		-Server
	}

	# Access logs
	log {
		output file /var/log/caddy/grafana-access.log {
			roll_size 100mb
			roll_keep 10
		}
	}
}
