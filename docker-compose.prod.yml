version: '3.8'

services:
  # PostgreSQL - Production database
  postgres:
    image: postgres:16-alpine
    container_name: mixdrop-postgres
    ports:
      - "127.0.0.1:5432:5432"  # Only expose to localhost
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-mixdrop}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD must be set}
      POSTGRES_DB: ${POSTGRES_DB:-mixdrop}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-mixdrop}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis - Caching layer with password protection
  redis:
    image: redis:7-alpine
    container_name: mixdrop-redis-prod
    ports:
      - "127.0.0.1:6379:6379"  # Only expose to localhost
    volumes:
      - redis_data:/data
    command: >
      redis-server
      --appendonly yes
      --requirepass ${REDIS_PASSWORD:?REDIS_PASSWORD must be set}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  # MinIO - S3-compatible storage
  # OPTIONAL: Remove if using AWS S3 or other external S3 service
  minio:
    image: minio/minio:latest
    container_name: mixdrop-minio-prod
    ports:
      - "127.0.0.1:9000:9000"  # Only expose to localhost (use reverse proxy)
      - "127.0.0.1:9001:9001"  # Console
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # MinIO Client - Create bucket and configure CORS on startup
  minio-setup:
    image: minio/mc:latest
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c "
      sleep 5;
      mc alias set myminio http://minio:9000 ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD};
      mc mb myminio/${S3_BUCKET} --ignore-existing;
      mc anonymous set download myminio/${S3_BUCKET};
      mc anonymous set upload myminio/${S3_BUCKET};
      mc cors set /tmp/cors.json myminio/${S3_BUCKET};
      exit 0;
      "
    volumes:
      - ./config/minio-cors.json:/tmp/cors.json:ro

  # Loki - Log aggregation
  loki:
    image: grafana/loki:3.0.0
    container_name: mixdrop-loki-prod
    user: "0:0"  # Run as root to avoid permission issues
    ports:
      - "127.0.0.1:3100:3100"  # Only expose to localhost
    volumes:
      - ./config/loki-config.yml:/etc/loki/local-config.yaml
      - loki_data:/loki
    command: -config.file=/etc/loki/local-config.yaml
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3100/ready"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Promtail - Log collector
  promtail:
    image: grafana/promtail:3.0.0
    container_name: mixdrop-promtail-prod
    volumes:
      - ./config/promtail-config.yml:/etc/promtail/config.yml
      - /var/run/docker.sock:/var/run/docker.sock
    command: -config.file=/etc/promtail/config.yml
    restart: unless-stopped
    depends_on:
      - loki

  # Grafana - Observability UI
  grafana:
    image: grafana/grafana:11.0.0
    container_name: mixdrop-grafana-prod
    ports:
      - "127.0.0.1:3001:3000"  # Only expose to localhost (use reverse proxy)
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:?GRAFANA_ADMIN_PASSWORD must be set}
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=${GRAFANA_ROOT_URL:-http://localhost:3001}
      - GF_SECURITY_SECRET_KEY=${GRAFANA_SECRET_KEY}
      - GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH=/etc/grafana/provisioning/dashboards/application-overview.json
    volumes:
      - grafana_data:/var/lib/grafana
      - ./config/grafana/datasources:/etc/grafana/provisioning/datasources
      - ./config/grafana/dashboards:/etc/grafana/provisioning/dashboards
    restart: unless-stopped
    depends_on:
      - loki
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Next.js Application
  app:
    image: ghcr.io/colegreenlee/mix-drop:latest
    # Uncomment to build locally instead of pulling from GHCR:
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    container_name: mixdrop-app-prod
    ports:
      - "127.0.0.1:3000:3000"  # Only expose to localhost (use reverse proxy)
    environment:
      # Database - PostgreSQL
      - DATABASE_URL=postgresql://${POSTGRES_USER:-mixdrop}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-mixdrop}?schema=public

      # Redis with password
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379

      # S3/MinIO (update these for AWS S3 in production)
      - S3_ENDPOINT=${S3_ENDPOINT}
      - S3_PUBLIC_ENDPOINT=${S3_PUBLIC_ENDPOINT}
      - S3_BUCKET=${S3_BUCKET}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
      - S3_REGION=${S3_REGION:-us-east-1}
      - S3_FORCE_PATH_STYLE=${S3_FORCE_PATH_STYLE:-false}

      # NextAuth
      - NEXTAUTH_URL=${NEXTAUTH_URL}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}

      # OAuth Provider (PRODUCTION - configure your real SSO)
      - OAUTH_CLIENT_ID=${OAUTH_CLIENT_ID}
      - OAUTH_CLIENT_SECRET=${OAUTH_CLIENT_SECRET}
      - OAUTH_ISSUER=${OAUTH_ISSUER}
      - OAUTH_AUTHORIZATION_URL=${OAUTH_AUTHORIZATION_URL}
      - OAUTH_TOKEN_URL=${OAUTH_TOKEN_URL}
      - OAUTH_USERINFO_URL=${OAUTH_USERINFO_URL}

      # Admin configuration
      - ADMIN_EMAILS=${ADMIN_EMAILS}

      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-info}

      # Node environment
      - NODE_ENV=production
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      # OPTIONAL: Remove minio dependencies if using external S3
      minio:
        condition: service_healthy
      minio-setup:
        condition: service_completed_successfully
      loki:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --timeout=5 http://127.0.0.1:3000 -O /dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "com.docker.compose.project=mix-drop"

  # Caddy - Reverse Proxy with Automatic HTTPS
  caddy:
    image: caddy:2-alpine
    container_name: mixdrop-caddy-prod
    restart: unless-stopped
    ports:
      - "80:80"        # HTTP (auto-redirects to HTTPS)
      - "443:443"      # HTTPS
      - "443:443/udp"  # HTTP/3 (QUIC)
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
      - caddy_logs:/var/log/caddy
    environment:
      - APP_DOMAIN=${APP_DOMAIN}
      - GRAFANA_DOMAIN=${GRAFANA_DOMAIN}
      - MINIO_DOMAIN=${MINIO_DOMAIN}
      - MINIO_CONSOLE_DOMAIN=${MINIO_CONSOLE_DOMAIN}
      - ACME_EMAIL=${ACME_EMAIL}
    depends_on:
      app:
        condition: service_healthy
      grafana:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "caddy", "validate", "--config", "/etc/caddy/Caddyfile"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - default

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  minio_data:
    driver: local
  loki_data:
    driver: local
  grafana_data:
    driver: local
  caddy_data:
    driver: local
  caddy_config:
    driver: local
  caddy_logs:
    driver: local

networks:
  default:
    name: mixdrop-prod
